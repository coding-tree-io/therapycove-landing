{%- assign widths = include.widths | split: ',' -%}
{%- assign base = include.src | replace: '.jpg', '' | replace: '.jpeg', '' | replace: '.png', '' -%}
{%- assign base_url = base | relative_url -%}
{%- assign sizes_attr = include.sizes | default: '100vw' -%}

{%- capture srcset_avif -%}
{%- for w in widths -%}
{{ base_url }}-{{ w | strip }}.avif {{ w | strip }}w{% unless forloop.last %}, {% endunless %}
{%- endfor -%}
{%- endcapture -%}

{%- capture srcset_webp -%}
{%- for w in widths -%}
{{ base_url }}-{{ w | strip }}.webp {{ w | strip }}w{% unless forloop.last %}, {% endunless %}
{%- endfor -%}
{%- endcapture -%}

{%- capture srcset_jpg -%}
{%- for w in widths -%}
{{ base_url }}-{{ w | strip }}.jpg {{ w | strip }}w{% unless forloop.last %}, {% endunless %}
{%- endfor -%}
{%- endcapture -%}

<picture>
  <source type="image/avif" srcset="{{ srcset_avif | strip }}" sizes="{{ sizes_attr }}">
  <source type="image/webp" srcset="{{ srcset_webp | strip }}" sizes="{{ sizes_attr }}">
  <img
    alt="{{ include.alt }}"
    src="{{ include.src | relative_url }}"
    srcset="{{ srcset_jpg | strip }}"
    sizes="{{ sizes_attr }}"
    {% if include.width %}width="{{ include.width }}"{% endif %}
    {% if include.height %}height="{{ include.height }}"{% endif %}
    {% if include.class %}class="{{ include.class }}"{% endif %}
    {% if include.loading %}loading="{{ include.loading }}"{% endif %}
    {% if include.fetchpriority %}fetchpriority="{{ include.fetchpriority }}"{% endif %}
    decoding="{{ include.decoding | default: 'async' }}"
  >
</picture>
